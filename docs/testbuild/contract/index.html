<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Smart Contract &#8212; microraiden 0.2.2
 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/jquery.mCustomScrollbar.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="JavaScript client library" href="../jsclient/index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

<nav id="navbar" class="navbar navbar-default navbar-fixed-top" style="border-bottom-width: 0px; color: #333">
    <div class="container-fluid" style="padding-left: 10px; padding-right: 10px; background-color: #f2f2f2; color: #333">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
           <a href ="/">
             <img src="../_images/Raiden_Logo.png" height=40 alt="Raiden logo">
           </a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <!--<li style="margin-top: 4px">
                  <a class="page-scroll" href="/">Home</a>
              </li>-->
                <li style="margin-top: 4px">
                    <a class="link" href="/101.html">101</a>
                </li>
                <li style="margin-top: 4px">
                    <a class="link" style="text-transform: none" href="/micro.html">µRaiden</a>
                </li>
                <li style="margin-top: 4px">
                    <a class="link" href="/developers.html">Developers</a>
                </li>
                <li style="margin-top: 4px">
                    <a class="link" href="/faq.html">FAQ</a>
                </li>

                <li style="margin-top: 4px">
                    <a class="link" href="https://token.raiden.network/">Token</a>
                </li>
              <!--  <li>
                    <a class="link" style="color: #cecece" href="/faq_cn.html">中文</a>
                </li>-->
              <!--<li class="social-icon">
                    <a class="link" href="https://gitter.im/raiden-network/raiden" target="_blank">
                      <img src="../img/riot.png" style="width:15px"></i>
                    </a>
                </li>
                <li class="link">
                  <a rel="noopener noreferrer" href="https://www.youtube.com/channel/UCoUP_hnjUddEvbxmtNCcApg" target="_blank">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tv">
                      <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline>
                    </svg>
                  </a>
                </li>
                <li class="link">
                  <a rel="noopener noreferrer" href="https://riot.im/app/#/room/#raiden-network:matrix.org" target="_blank">
                   <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-circle">
                      <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                  </a>
            </li>
            <li class="link">
                  <a rel="noopener noreferrer" href="https://github.com/raiden-network/raiden/" target="_blank">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github">
                      <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                    </svg>
                  </a>
                </li>
                <li class="link">
                  <a rel="noopener noreferrer" href="https://www.reddit.com/r/raidennetwork/" target="_blank">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1">
                      <path d="M2.204 14.049c-.06.276-.091.56-.091.847 0 3.443 4.402 6.249 9.814 6.249 5.41 0 9.812-2.804 9.812-6.249 0-.274-.029-.546-.082-.809l-.015-.032c-.021-.055-.029-.11-.029-.165-.302-1.175-1.117-2.241-2.296-3.103-.045-.016-.088-.039-.126-.07-.026-.02-.045-.042-.067-.064-1.792-1.234-4.356-2.008-7.196-2.008-2.815 0-5.354.759-7.146 1.971-.014.018-.029.033-.049.049-.039.033-.084.06-.13.075-1.206.862-2.042 1.937-2.354 3.123 0 .058-.014.114-.037.171l-.008.015zm9.773 5.441c-1.794 0-3.057-.389-3.863-1.197-.173-.174-.173-.457 0-.632.176-.165.46-.165.635 0 .63.629 1.685.943 3.228.943 1.542 0 2.591-.3 3.219-.929.165-.164.45-.164.629 0 .165.18.165.465 0 .645-.809.808-2.065 1.198-3.862 1.198l.014-.028zm-3.606-7.573c-.914 0-1.677.765-1.677 1.677 0 .91.763 1.65 1.677 1.65s1.651-.74 1.651-1.65c0-.912-.739-1.677-1.651-1.677zm7.233 0c-.914 0-1.678.765-1.678 1.677 0 .91.764 1.65 1.678 1.65s1.651-.74 1.651-1.65c0-.912-.739-1.677-1.651-1.677zm4.548-1.595c1.037.833 1.8 1.821 2.189 2.904.45-.336.719-.864.719-1.449 0-1.002-.815-1.816-1.818-1.816-.399 0-.778.129-1.09.363v-.002zM2.711 9.963c-1.003 0-1.817.816-1.817 1.818 0 .543.239 1.048.644 1.389.401-1.079 1.172-2.053 2.213-2.876-.302-.21-.663-.329-1.039-.329v-.002zm9.217 12.079c-5.906 0-10.709-3.205-10.709-7.142 0-.275.023-.544.068-.809C.494 13.598 0 12.729 0 11.777c0-1.496 1.227-2.713 2.725-2.713.674 0 1.303.246 1.797.682 1.856-1.191 4.357-1.941 7.112-1.992l1.812-5.524.404.095s.016 0 .016.002l4.223.993c.344-.798 1.138-1.36 2.065-1.36 1.229 0 2.231 1.004 2.231 2.234 0 1.232-1.003 2.234-2.231 2.234s-2.23-1.004-2.23-2.23l-3.851-.912-1.467 4.477c2.65.105 5.047.854 6.844 2.021.494-.464 1.144-.719 1.833-.719 1.498 0 2.718 1.213 2.718 2.711 0 .987-.54 1.886-1.378 2.365.029.255.059.494.059.749-.015 3.938-4.806 7.143-10.72 7.143l-.034.009zm8.179-19.187c-.74 0-1.34.599-1.34 1.338 0 .738.6 1.34 1.34 1.34.732 0 1.33-.6 1.33-1.334 0-.733-.598-1.332-1.347-1.332l.017-.012z"></path>
                    </svg>
                  </a>
                </li>
                      -->
            </ul>
        </div>
         <!--/.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>

<div class="container" style="margin-left: 30px; padding-top: 20px">
  <div class="row">
      <div class="col-md-3" style="padding-top: 20px;">
        <div class="bs-sidenav affix-top" role="complementary">
  <div data-spy="scroll" data-target="#sidebar" class="row container">
    <div id="sidebar" data-mcs-theme="minimal-dark" class="custom-scrollbar">
	<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Brief Overview</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmdline.html">Command line options</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../proxy-tutorial.html">Proxy tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev-overview.html">Components overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../jsclient/index.html">JavaScript client library</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Smart Contract</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Smart Contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
</ul>

  </div>
  </div>
        </div>
      </div>
    <div class="col-md-9 content" style="margin-top: 20px;">
      
  <div class="section" id="smart-contract">
<h1>Smart Contract<a class="headerlink" href="#smart-contract" title="Permalink to this headline">¶</a></h1>
<p>Smart Contracts, Unittests and Infrastructure for RaidenPaymentChannel</p>
<div class="toctree-wrapper compound">
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Smart Contract</a></li>
</ul>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>The Smart Contracts can be installed separately from the other
components.</p>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Python 3.6</li>
<li><a class="reference external" href="https://pip.pypa.io/en/stable/">pip</a></li>
</ul>
</div>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>from <code class="docutils literal"><span class="pre">root/contracts</span></code>:</li>
</ul>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="c1"># compilation</span>
<span class="n">populus</span> <span class="nb">compile</span>

<span class="c1"># tests</span>
<span class="n">pytest</span>
<span class="n">pytest</span> <span class="o">-</span><span class="n">p</span> <span class="n">no</span><span class="p">:</span><span class="n">warnings</span> <span class="o">-</span><span class="n">s</span>
<span class="n">pytest</span> <span class="n">tests</span><span class="o">/</span><span class="n">test_uraiden</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">p</span> <span class="n">no</span><span class="p">:</span><span class="n">warnings</span> <span class="o">-</span><span class="n">s</span>

<span class="c1"># Recommended for speed:</span>
<span class="c1"># you have to comment lines in tests/conftest.py to use this</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">pytest</span><span class="o">-</span><span class="n">xdist</span><span class="o">==</span><span class="mf">1.17</span><span class="o">.</span><span class="mi">1</span>
<span class="n">pytest</span> <span class="o">-</span><span class="n">p</span> <span class="n">no</span><span class="p">:</span><span class="n">warnings</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">n</span> <span class="n">NUM_OF_CPUs</span>
</pre></div>
</div>
</div>
<div class="section" id="deployment">
<h3>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h3>
<div class="section" id="chain-setup-for-testing">
<h4>Chain setup for testing<a class="headerlink" href="#chain-setup-for-testing" title="Permalink to this headline">¶</a></h4>
<p>Note - you can change RPC/IPC chain connection, timeout parameters etc. in <a class="reference external" href="https://github.com/raiden-network/microraiden/blob/master/contracts/project.json">project.json</a></p>
<div class="section" id="privtest">
<h5><strong>privtest</strong><a class="headerlink" href="#privtest" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Start the geth-node from the commandline:</li>
</ol>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span>geth --ipcpath<span class="o">=</span><span class="s2">&quot;~/Library/Ethereum/privtest/geth.ipc&quot;</span> <span class="se">\</span>
     --datadir<span class="o">=</span><span class="s2">&quot;~/Library/Ethereum/privtest&quot;</span> <span class="se">\</span>
     --dev <span class="se">\</span>
     ---rpc --rpccorsdomain <span class="s1">&#39;\*&#39;</span> --rpcport <span class="m">8545</span> <span class="se">\</span>
     --rpcapi eth,net,web3,personal <span class="se">\</span>
     --unlock 0xf590ee24CbFB67d1ca212e21294f967130909A5a <span class="se">\</span>
     --password ~/password.txt

<span class="c1"># geth console</span>
<span class="c1"># you have to mine yourself: miner.start()</span>
geth attach ipc:/Users/loredana/Library/Ethereum/privtest/geth.ipc
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="kovan">
<h5><strong>kovan</strong><a class="headerlink" href="#kovan" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Get some testnet-Ether at the <a class="reference external" href="https://gitter.im/kovan-testnet/faucet">kovan-faucet</a></li>
<li>Modify the <a class="reference external" href="https://github.com/raiden-network/microraiden/blob/master/contracts/project.json#L179">project.json</a> to change the default account</li>
<li>Start the <a class="reference external" href="https://github.com/paritytech/parity">Parity</a> node from the commandline:</li>
</ol>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span>parity --geth <span class="se">\</span>
       --chain kovan <span class="se">\</span>
       --force-ui --reseal-min-period <span class="m">0</span> <span class="se">\</span>
       --jsonrpc-cors http://localhost <span class="se">\</span>
       --jsonrpc-apis web3,eth,net,parity,traces,rpc,personal <span class="se">\</span>
       --unlock 0x5601Ea8445A5d96EEeBF89A67C4199FbB7a43Fbb <span class="se">\</span>
       --password ~/password.txt <span class="se">\</span>
       --author 0x5601Ea8445A5d96EEeBF89A67C4199FbB7a43Fbb
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="ropsten">
<h5><strong>ropsten</strong><a class="headerlink" href="#ropsten" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Get some testnet-Ether at the <a class="reference external" href="https://www.reddit.com/r/ethdev/comments/61zdn8/if_you_need_some_ropsten_testnet_ethers/">ropsten-faucet</a></li>
<li>Modify the <a class="reference external" href="https://github.com/raiden-network/microraiden/blob/master/contracts/project.json#L49">project.json</a> to change the default account</li>
<li>Start the geth node from the commandline:</li>
</ol>
<div class="highlight-sh"><div class="highlight"><pre><span></span>geth --testnet <span class="se">\</span>
     --rpc --rpcport <span class="m">8545</span> <span class="se">\</span>
     --unlock 0xbB5AEb01acF5b75bc36eC01f5137Dd2728FbE983 <span class="se">\</span>
     --password ~/password.txt
</pre></div>
</div>
</div>
<div class="section" id="rinkeby">
<h5><strong>rinkeby</strong><a class="headerlink" href="#rinkeby" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Get some testnet-Ether at the <a class="reference external" href="https://www.rinkeby.io/#faucet">rinkeby-faucet</a></li>
<li>Modify the <a class="reference external" href="https://github.com/raiden-network/microraiden/blob/master/contracts/project.json#L214">/contracts/project.json</a> to change the default account</li>
</ol>
</div>
<div class="section" id="fast-deployment">
<h5><strong>Fast deployment</strong><a class="headerlink" href="#fast-deployment" title="Permalink to this headline">¶</a></h5>
<p>There are some scripts to provide you with convenient ways to setup a quick deployment.</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Fast deploy on kovan | ropsten | rinkeby | tester | privtest</span>

<span class="c1"># Following two calls are equivalent</span>
python -m deploy.deploy_testnet  <span class="c1"># --owner is web.eth.accounts[0]</span>
python -m deploy.deploy_testnet <span class="se">\</span>
  --chain kovan <span class="se">\</span>
  --owner 0x5601Ea8445A5d96EEeBF89A67C4199FbB7a43Fbb <span class="se">\</span>
  --challenge-period <span class="m">500</span> <span class="se">\</span>
  --token-name CustomToken --token-symbol TKN <span class="se">\</span>
  --supply <span class="m">10000000</span> --token-decimals <span class="m">18</span>

<span class="c1"># Provide a custom deployed token</span>
python -m deploy.deploy_testnet --token-address TOKEN_ADDRESS
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="api">
<span id="contract-development"></span><h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="generated-docs">
<h3>Generated docs<a class="headerlink" href="#generated-docs" title="Permalink to this headline">¶</a></h3>
<p>There is an <a class="reference external" href="https://github.com/raiden-network/microraiden/blob/master/docs/contract/RaidenMicroTransferChannels.md">Auto-Generated-API</a>, that is compiled with <cite>soldocs</cite>.</p>
<p>Prerequisites</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">soldocs</span>
<span class="n">populus</span> <span class="nb">compile</span>
<span class="n">soldocs</span> <span class="o">--</span><span class="nb">input</span> <span class="n">build</span><span class="o">/</span><span class="n">contracts</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">output</span> <span class="n">docs</span><span class="o">/</span><span class="n">contract</span><span class="o">/</span><span class="n">RaidenMicroTransferChannels</span><span class="o">.</span><span class="n">md</span> <span class="o">--</span><span class="n">contracts</span> <span class="n">RaidenMicroTransferChannels</span>
</pre></div>
</div>
</div>
<div class="section" id="opening-a-transfer-channel">
<h3>Opening a transfer channel<a class="headerlink" href="#opening-a-transfer-channel" title="Permalink to this headline">¶</a></h3>
<div class="section" id="erc223-compatible-recommended">
<h4>ERC223 compatible (recommended)<a class="headerlink" href="#erc223-compatible-recommended" title="Permalink to this headline">¶</a></h4>
<p>Sender sends tokens to the Contract, with a payload for calling
<code class="docutils literal"><span class="pre">createChannelPrivate</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Token</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">_to</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">_data</span><span class="p">)</span>
</pre></div>
</div>
<p>Gas cost (testing): 88976</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">_to</span></code> = <code class="docutils literal"><span class="pre">Contract.address</span></code></li>
<li><code class="docutils literal"><span class="pre">_value</span></code> = deposit value (number of tokens)</li>
<li><code class="docutils literal"><span class="pre">_data</span></code> contains the Sender and Receiver addresses encoded in 20 bytes</li>
<li>in python <code class="docutils literal"><span class="pre">_data</span> <span class="pre">=</span> <span class="pre">bytes.fromhex(sender_address[2:]</span> <span class="pre">+</span> <span class="pre">receiver_address[2:])</span></code></li>
</ul>
<div class="figure">
<img alt="../_images/ChannelOpen_223.png" src="../_images/ChannelOpen_223.png" />
</div>
</div>
<div class="section" id="erc20-compatible">
<h4>ERC20 compatible<a class="headerlink" href="#erc20-compatible" title="Permalink to this headline">¶</a></h4>
<div class="code py highlight-default"><div class="highlight"><pre><span></span><span class="c1"># approve token transfers to the contract from the Sender&#39;s behalf</span>
<span class="n">Token</span><span class="o">.</span><span class="n">approve</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">deposit</span><span class="p">)</span>

<span class="n">Contract</span><span class="o">.</span><span class="n">createChannel</span><span class="p">(</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">deposit</span><span class="p">)</span>
</pre></div>
</div>
<p>Gas cost (testing): 120090</p>
<div class="figure">
<img alt="../_images/ChannelOpen_20.png" src="../_images/ChannelOpen_20.png" />
</div>
</div>
</div>
<div class="section" id="topping-up-a-channel">
<h3>Topping up a channel<a class="headerlink" href="#topping-up-a-channel" title="Permalink to this headline">¶</a></h3>
<p>Adding tokens to an already opened channel.</p>
<div class="section" id="id1">
<h4>ERC223 compatible (recommended)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Sender sends tokens to the Contract, with a payload for calling
<code class="docutils literal"><span class="pre">topUp</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Token</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">_to</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">_data</span><span class="p">)</span>
</pre></div>
</div>
<p>Gas cost (testing): 54885</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">_to</span></code> = <code class="docutils literal"><span class="pre">Contract.address</span></code></li>
<li><code class="docutils literal"><span class="pre">_value</span></code> = deposit value (number of tokens)</li>
<li><code class="docutils literal"><span class="pre">_data</span></code> contains the Sender and Receiver addresses encoded in 20 bytes + the
open_block_number in 4 bytes</li>
<li>in python</li>
</ul>
<div class="code py highlight-default"><div class="highlight"><pre><span></span><span class="n">_data</span> <span class="o">=</span> <span class="n">sender_address</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="n">receiver_address</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">open_block_number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure">
<img alt="../_images/ChannelTopUp_223.png" src="../_images/ChannelTopUp_223.png" />
</div>
</div>
<div class="section" id="id2">
<h4>ERC20 compatible<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="code py highlight-default"><div class="highlight"><pre><span></span><span class="c1">#approve token transfers to the contract from the Sender&#39;s behalf</span>
<span class="n">Token</span><span class="o">.</span><span class="n">approve</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">added_deposit</span><span class="p">)</span>

<span class="c1"># open_block_number = block number at which the channel was opened</span>
<span class="n">Contract</span><span class="o">.</span><span class="n">topUp</span><span class="p">(</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">open_block_number</span><span class="p">,</span> <span class="n">added_deposit</span><span class="p">)</span>
</pre></div>
</div>
<p>Gas cost (testing): 85414</p>
<div class="figure">
<img alt="../_images/ChannelTopUp_20.png" src="../_images/ChannelTopUp_20.png" />
</div>
</div>
</div>
<div class="section" id="generating-and-validating-a-balance-proof">
<span id="contract-validate-balance-proof"></span><h3>Generating and validating a balance proof<a class="headerlink" href="#generating-and-validating-a-balance-proof" title="Permalink to this headline">¶</a></h3>
<p>(to be updated post EIP712)</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Sender has to provide a balance proof to the Receiver when making a micropayment</span>
<span class="c1"># The contract implements some helper functions for that</span>

<span class="c1"># Balance message</span>
<span class="n">bytes32</span> <span class="n">balance_message_hash</span> <span class="o">=</span> <span class="n">keccak256</span><span class="p">(</span>
    <span class="n">keccak256</span><span class="p">(</span>
        <span class="s1">&#39;string message_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;address receiver&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uint32 block_created&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uint192 balance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;address contract&#39;</span>
    <span class="p">),</span>
    <span class="n">keccak256</span><span class="p">(</span>
        <span class="s1">&#39;Sender balance proof signature&#39;</span><span class="p">,</span>
        <span class="n">_receiver_address</span><span class="p">,</span>
        <span class="n">_open_block_number</span><span class="p">,</span>
        <span class="n">_balance</span><span class="p">,</span>
        <span class="n">address</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="c1"># balance_message_hash is signed by the Sender with MetaMask</span>
<span class="n">balance_msg_sig</span>

<span class="c1"># Data is sent to the Receiver (receiver, open_block_number, balance, balance_msg_sig)</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-and-validating-a-closing-agreement">
<span id="contract-validate-close"></span><h3>Generating and validating a closing agreement<a class="headerlink" href="#generating-and-validating-a-closing-agreement" title="Permalink to this headline">¶</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eth_utils</span> <span class="k">import</span> <span class="n">encode_hex</span>

<span class="c1"># Sender has to provide a balance proof to the Contract and</span>
<span class="c1"># a closing agreement proof from Receiver (closing_sig)</span>
<span class="c1"># closing_sig is created in the same way as balance_msg_sig, but it is signed by the Receiver</span>

<span class="c1"># Closing signature message</span>
<span class="n">bytes32</span> <span class="n">balance_message_hash</span> <span class="o">=</span> <span class="n">keccak256</span><span class="p">(</span>
    <span class="n">keccak256</span><span class="p">(</span>
        <span class="s1">&#39;string message_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;address sender&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uint32 block_created&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uint192 balance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;address contract&#39;</span>
    <span class="p">),</span>
    <span class="n">keccak256</span><span class="p">(</span>
        <span class="s1">&#39;Receiver closing signature&#39;</span><span class="p">,</span>
        <span class="n">_sender_address</span><span class="p">,</span>
        <span class="n">_open_block_number</span><span class="p">,</span>
        <span class="n">_balance</span><span class="p">,</span>
        <span class="n">address</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="c1"># balance_message_hash is signed by the Sender with MetaMask</span>
<span class="n">balance_msg_sig</span>

<span class="c1"># balance_msg_sig is signed by the Receiver inside the microraiden code</span>
<span class="n">closing_sig</span>

<span class="c1"># Send to the Contract (example of collaborative closing, transaction sent by Sender)</span>
<span class="n">Contract</span><span class="o">.</span><span class="n">transact</span><span class="p">({</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">Sender</span> <span class="p">})</span><span class="o">.</span><span class="n">cooperativeClose</span><span class="p">(</span>
    <span class="n">_receiver_address</span><span class="p">,</span>
    <span class="n">_open_block_number</span><span class="p">,</span>
    <span class="n">_balance</span><span class="p">,</span>
    <span class="n">_balance_msg_sig</span><span class="p">,</span>
    <span class="n">_closing_sig</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="balance-proof-closing-agreement-signature-verification">
<h4>Balance proof / closing agreement signature verification:<a class="headerlink" href="#balance-proof-closing-agreement-signature-verification" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">sender_address</span> <span class="o">=</span> <span class="n">Contract</span><span class="o">.</span><span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">extractBalanceProofSignature</span><span class="p">(</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">open_block_number</span><span class="p">,</span> <span class="n">balance</span><span class="p">,</span> <span class="n">balance_msg_sig</span><span class="p">)</span>

<span class="n">receiver_address</span> <span class="o">=</span> <span class="n">Contract</span><span class="o">.</span><span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">extractClosingSignature</span><span class="p">(</span><span class="n">sender_address</span><span class="p">,</span> <span class="n">open_block_number</span><span class="p">,</span> <span class="n">balance</span><span class="p">,</span> <span class="n">closing_sig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="closing-a-channel">
<h3>Closing a channel<a class="headerlink" href="#closing-a-channel" title="Permalink to this headline">¶</a></h3>
<div class="code py highlight-default"><div class="highlight"><pre><span></span><span class="c1"># 1. Receiver calls Contract with the sender&#39;s signed balance message = instant close &amp; settle</span>
<span class="c1"># 2. Client calls Contract with receiver&#39;s closing signature = instant close &amp; settle</span>
<span class="c1"># Gas cost (testing): 71182</span>
<span class="n">Contract</span><span class="o">.</span><span class="n">cooperativeClose</span><span class="p">(</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">open_block_number</span><span class="p">,</span> <span class="n">balance</span><span class="p">,</span> <span class="n">balance_msg_sig</span><span class="p">,</span> <span class="n">closing_sig</span><span class="p">)</span>

<span class="c1"># 3. Client calls Contract without receiver&#39;s closing signature = challenge period starts, channel is not settled yet</span>
<span class="c1"># Gas cost (testing): 53876</span>
<span class="n">Contract</span><span class="o">.</span><span class="n">uncooperativeClose</span><span class="p">(</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">open_block_number</span><span class="p">,</span> <span class="n">balance</span><span class="p">)</span>

<span class="c1"># 3.a. During the challenge period, 1. can happen.</span>

<span class="c1"># 3.b. Client calls Contract after settlement period ends</span>
<span class="c1"># Gas cost (testing): 40896</span>
<span class="n">Contract</span><span class="o">.</span><span class="n">settle</span><span class="p">(</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">open_block_number</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure">
<img alt="../_images/ChannelCycle.png" src="../_images/ChannelCycle.png" />
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, brainbot labs Est..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </p>
  </div>
</footer>
  </body>
</html>